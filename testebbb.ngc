%
;
; Projeto: fazer fresa para PCI na router CNC
; Inicial: 27/jan/2019
; correcoes 30/jan/2019
; reformulacao 31/jan/2019
; sangue, suor e lagrimas: 01 a 10/fev/2019
;

;
; Rotina de desbaste
;
o100 sub
   #30 = #6;
   #25 = [[#3 - #1] / SQRT[[#3 - #1] * [#3 - #1] + [#4 - #2] * [#4 - #2]]] ; Cos(alpha)
   #26 = [[#4 - #2] / SQRT[[#3 - #1] * [#3 - #1] + [#4 - #2] * [#4 - #2]]] ; Sen(alpha)
   #21 = [#1 + [#5 + #6] * #26] ; Ax'= Ax + D * SIN(alpha)
   #22 = [#2 - [#5 + #6] * #25] ; Ay'= Ay + D * COS(alpha)
   G00 z#09
   G00 x#21 y#22
   G01 z#10 F[#7/2]
   o101 while [#30 GE 0.0]
      #21 = [#1 + [#5 + #30] * #26] ; Ax'= Ax + D * SIN(alpha)
      #22 = [#2 - [#5 + #30] * #25] ; Ay'= Ay + D * COS(alpha)
      #23 = [#3 + [#5 + #30] * #26] ; Bx'= Bx + D * SIN(alpha)
      #24 = [#4 - [#5 + #30] * #25] ; By'= Bx + D * COS(alpha)
      G01 x#21 y#22
      G01 x#23 y#24
      G01 x#21 y#22
      #30 = [#30 - #8]
   o101 endwhile
   #21 = [#1 + [#5 + #6] * #26] ; Ax'= Ax + D * SIN(alpha)
   #22 = [#2 - [#5 + #6] * #25] ; Ay'= Ay + D * COS(alpha)
   G00 x#21 y#22
   G00 z#09
o100 endsub

;
; Rotina de desbaste
;
o100 sub
   #30 = #6;
   #25 = [[#3 - #1] / SQRT[[#3 - #1] * [#3 - #1] + [#4 - #2] * [#4 - #2]]] ; Cos(alpha)
   #26 = [[#4 - #2] / SQRT[[#3 - #1] * [#3 - #1] + [#4 - #2] * [#4 - #2]]] ; Sen(alpha)
   #21 = [#1 + [#5 + #6] * #26] ; Ax'= Ax + D * SIN(alpha)
   #22 = [#2 - [#5 + #6] * #25] ; Ay'= Ay + D * COS(alpha)
   G00 z#09
   G00 x#21 y#22
   G01 z#10 F[#7/2]
   o101 while [#30 GE 0.0]
      #21 = [#1 + [#5 + #30] * #26] ; Ax'= Ax + D * SIN(alpha)
      #22 = [#2 - [#5 + #30] * #25] ; Ay'= Ay + D * COS(alpha)
      #23 = [#3 + [#5 + #30] * #26] ; Bx'= Bx + D * SIN(alpha)
      #24 = [#4 - [#5 + #30] * #25] ; By'= Bx + D * COS(alpha)
      G01 x#21 y#22
      G01 x#23 y#24
      G01 x#21 y#22
      #30 = [#30 - #8]
   o101 endwhile
   #21 = [#1 + [#5 + #6] * #26] ; Ax'= Ax + D * SIN(alpha)
   #22 = [#2 - [#5 + #6] * #25] ; Ay'= Ay + D * COS(alpha)
   G00 x#21 y#22
   G00 z#09
o100 endsub

;
; Subroutine to rought cutting and finishing
;
o200 sub
   #30 = #6 ; #06 = distance to start cutting
            ; #30 = variable distance from finish face
   #23 = SQRT[[#3 - #1] * [#3 - #1] + [#4 - #2] * [#4 - #2]] ; #23 = H: hypotenuse
   #25= [#3 - #1] / #23
   ;Cos(Alpha)= (Bx-Ax) / H
   
   #26= [#4 - #2] / #23
   ;Sin(Alpha)= (By-Ay) / H
   
   #21 = [[#1 + [#5 + #6] * #26] - #12 * #25]
   ;Ax'= (Ax + (D+d) * SIN(alpha)) - dA * COS(alpha)
   
   #22 = [[#2 - [#5 + #6] * #25] - #12 * #26] 
   ;Ay'= (Ay + (D+d) * COS(alpha)) - dA * SIN(alpha)
   
   G00 z#09 ; #09 = h: clearance height
   G00 x#21 y#22
   G01 z#10 F[#7/2] ; #07 = F: feedrate
   
   ;rought cutting
   o201 while [#30 GT #11]
      #21 = [[#1 + [#5 + #30] * #26] - #12 * #25]
    ; Ax'= (Ax + D * SIN(alpha)) - dA * COS(alpha)
    
      #22 = [[#2 - [#5 + #30] * #25] - #12 * #26]
    ; Ay'= (Ay + D * COS(alpha)) - dA * SIN(alpha)
    
      #23 = [[#3 + [#5 + #30] * #26] + #13 * #25]
    ; Bx'= (Bx + D * SIN(alpha)) - dB * COS(alpha)
    
      #24 = [[#4 - [#5 + #30] * #25] + #13 * #26]
    ; By'= (Bx + D * COS(alpha)) - dB * SIN(alpha)
    
      G01 x#21 y#22 ; G01 (Ax',Ay') back
      G01 x#23 y#24 ; G01 (Bx',By') and forth
      G01 x#21 y#22 ; G01 (Ax',Ay') and back
      #30 = [#30 - #8] ; #30 = #30 - i
   o201 endwhile
   #21 = [[#1 + [#5 + #11] * #26] - #12 * #25]
   ; Ax'= (Ax + (D + s) * SIN(alpha)) - dA * COS(alpha)
   
   #22 = [[#2 - [#5 + #11] * #25] - #12 * #26]
   ; Ay'= (Ay + (D + s) * COS(alpha)) - dA * SIN(alpha)
   
   ;G00 x#21 y#22
   G00 z00
   ;finishing
   #21 = [[#1 + #3] / 2 + [#5 + #11] * #26]
   ; Mx'= (Ax + Bx) / 2 + (D + s) * SIN(alpha)
   
   #22 = [[#2 + #4] / 2 - [#5 + #11] * #25]
   ; My'= (Ay + By) / 2 - (D + s) * COS(alpha)
      
   #24 = -[[#5 / 2] * [1 - SQRT[1 - #23 * #23 / #5 / #5]]] ; (-1)*sagitta calculation
   
   G01 x#21 y#22
   o203 while [#30 GE #24]
      #21 = [[#1 + #3] / 2 + [#5 + #30] * #26] ; Ax'= Ax + D * SIN(alpha)
      #22 = [[#2 + #4] / 2 - [#5 + #30] * #25] ; Ay'= Ay + D * COS(alpha)
      G01 z0
      G01 x#21 y#22
      G01 z#10 F#7
      #30 = [#30 - #8]
   o203 endwhile
   G01 Z#10
   #21 = [[#1 + #3] / 2 + [#5 + #6] * #26] ; Ax'= Ax + D * SIN(alpha)
   #22 = [[#2 + #4] / 2 - [#5 + #6] * #25] ; Ay'= Ay + D * COS(alpha)
   G01 x#21 y#22
   G01 z#09 F[#7/5]
o200 endsub

G21 G90
T01

#100= -0.07 ; Ax coordenada x do ponto A (#1)
#101= 0.072 ; Ay coordenada y do ponto A (#2)
#102= -0.13 ; Bx coordenada x do ponto B (#3)
#103= 0.0   ; By coordenada y do ponto B (#4)
#104= 10    ; D  diametro da ferramenta (#5)
#105= 0.25  ; d  distancia do material a ser usinado(#6)
#106= 80.0  ; F  velocidade de avanco (#7)
#107= 0.02  ; i  avanco de corte(#8)
#108= 5     ; h  altura de movimentacao da ferramenta(#9)
#109= -0.8  ; g  profundidade da usinagem(#10)
#110= 0.1   ; s  sobrematerial entre as fases de desbaste e acabamento (#11)
#111= 2.0   ; dA movimento lado ponto A (#12)
#112= 0.5   ; dB movimento lado ponto B (#13)

;o100 call [#100] [#101] [#102] [#103] [#104] [#105] [#106] [#107] [#108] [#109]
o200 call [#100] [#101] [#102] [#103] [#104] [#105] [#106] [#107] [#108] [#109] [#110] [#111] [#112]

#100= 7.5   ; Ax coordenada x do ponto A (#1)
#101= 7.5   ; Ay coordenada y do ponto A (#2)
#102= 8     ; Bx coordenada x do ponto B (#3)
#103= 8     ; By coordenada y do ponto B (#4)
#104= 10    ; D  diametro da ferramenta (#5)
#105= 1     ; d  distancia do material a ser usinado(#6)
#106= 500   ; F  velocidade de avanco (#7)
#107= 0.1   ; i  profundidade de corte(#8)
#108= 2     ; h  altura de movimentacao da ferramenta(#9)
#109= -0.7  ; g  profundidade da usinagem(#10)
#110= 0.5   ; s  sobrematerial entre as fases de desbaste e acabamento (#11)
#111= 0.2   ; dA movimento lado ponto A (#12)
#112= 0.2   ; dB movimento lado ponto B (#13)

;o100 call [#100] [#101] [#102] [#103] [#104] [#105] [#106] [#107] [#108] [#109]
o200 call [#100] [#101] [#102] [#103] [#104] [#105] [#106] [#107] [#108] [#109] [#110] [#111] [#112]

#100= 2     ; Ax coordenada x do ponto A (#1)
#101= 2.5   ; Ay coordenada y do ponto A (#2)
#102= 3     ; Bx coordenada x do ponto B (#3)
#103= 3     ; By coordenada y do ponto B (#4)
#104= 10    ; D  diametro da ferramenta (#5)
#105= 1     ; d  distancia do material a ser usinado(#6)
#106= 500   ; F  velocidade de avanco (#7)
#107= 0.1   ; i  profundidade de corte(#8)
#108= 2     ; h  altura de movimentacao da ferramenta(#9)
#109= -0.7  ; g  profundidade da usinagem(#10)
#110= 0.5   ; s  sobrematerial entre as fases de desbaste e acabamento (#11)
#111= 0.3   ; dA movimento lado ponto A (#12)
#112= 0.3   ; dB movimento lado ponto B (#13)

;o100 call [#100] [#101] [#102] [#103] [#104] [#105] [#106] [#107] [#108] [#109]
o200 call [#100] [#101] [#102] [#103] [#104] [#105] [#106] [#107] [#108] [#109] [#110] [#111] [#112]

m2